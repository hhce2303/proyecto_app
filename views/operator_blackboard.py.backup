"""
OperatorBlackboard - Contenedor de tabs para operadores.
Hereda de Blackboard y personaliza para operador.

ENFOQUE ACTUAL: Solo tab Daily con DailyModule
PENDIENTES: Specials y Covers

IMPORTANTE: 
- DAILY = OPERADOR (crear eventos) - ‚úÖ FUNCIONANDO
- SPECIALS = OPERADOR (crear eventos especiales) - ‚è≥ Pendiente
- COVERS = OPERADOR (solicitar covers) - ‚è≥ Pendiente
"""
from views.blackboard import Blackboard
from views.modules.daily_module import DailyModule
from controllers.daily_controller import DailyController
from under_super import FilteredCombobox
import tkinter as tk

class OperatorBlackboard(Blackboard):
    """
    Blackboard para Operadores.
    Tab activo: Daily con DailyModule
    Tabs pendientes: Specials, Covers
    """
    
    def __init__(self, username, role, session_id=None, station=None, root=None):
        """Inicializa blackboard de operador"""
        self.current_tab = "Daily"
        self.tab_buttons = {}
        self.tab_frames = {}
        
        # Inicializar controller
        self.controller = DailyController(username)
        
        super().__init__(username, role, session_id, station, root)
        
        # Bot√≥n de logout
        #self.ui_factory.button(
            #parent,
            #text="üö™ Logout",
            #command=self._on_logout,
            #width=100,
            #fg_color="#d32f2f",
            #hover_color="#b71c1c"
        #).pack(side="right", padx=10)
    
    def _setup_tabs_content(self, parent):
        """Tabs de Operador: Daily, Specials, Covers"""
        tabs = [
            ("üìù Daily", "Daily"),
            ("‚≠ê Specials", "Specials"),
            ("üîÑ Covers", "Covers")
        ]
        
        for text, tab_name in tabs:
            btn = self.ui_factory.button(
                parent,
                text=text,
                command=lambda t=tab_name: self._switch_tab(t),
                width=120,
                fg_color="#4D6068"
            )
            btn.pack(side="left", padx=5, pady=10)
            self.tab_buttons[tab_name] = btn
        
        self._update_tab_buttons()
    
    def _setup_content(self, parent):
        """Contenido para tabs de operador"""
        
        # ========== TAB DAILY (EXCLUSIVO DE OPERADORES) ==========
        daily_frame = self.ui_factory.frame(parent, fg_color="#1e1e1e")
        
        # Formulario horizontal para agregar eventos
        form_frame = self.ui_factory.frame(daily_frame, fg_color="#2b2b2b")
        form_frame.pack(fill="x", padx=10, pady=10)
        
        self._create_event_form(form_frame)
        
        try:
            self.daily_module = DailyModule(
                parent=daily_frame,
                username=self.username,
                session_id=self.session_id,
                role=self.role,
                UI=self.UI
            )
            print(f"[DEBUG] DailyModule inicializado para OPERADOR: {self.username}")
        except Exception as e:
            print(f"[ERROR] No se pudo inicializar DailyModule: {e}")
            self.ui_factory.label(
                daily_frame,
                text=f"Error al cargar Daily: {e}",
                font=("Segoe UI", 12),
                fg="#ff4444"
            ).pack(pady=20)
        
        self.tab_frames["Daily"] = daily_frame
        
        # ========== TAB SPECIALS (OPERADOR CREA EVENTOS ESPECIALES) ==========
        specials_frame = self.ui_factory.frame(parent, fg_color="#23272a")
        self.ui_factory.label(
            specials_frame,
            text="Contenido de Specials",
            font=("Segoe UI", 18, "bold"),
            fg="#ffa500"
        ).pack(pady=20)
        self.ui_factory.label(
            specials_frame,
            text="Operador crea eventos especiales aqu√≠ (SpecialsModule pendiente)",
            font=("Segoe UI", 12),
            fg="#999999"
        ).pack(pady=10)
        self.tab_frames["Specials"] = specials_frame
        
        # ========== TAB COVERS (placeholder) ==========
        covers_frame = self.ui_factory.frame(parent, fg_color="#23272a")
        self.ui_factory.label(
            covers_frame,
            text="Contenido de Covers",
            font=("Segoe UI", 18, "bold"),
            fg="#00bfae"
        ).pack(pady=20)
        self.ui_factory.label(
            covers_frame,
            text="Pr√≥ximo m√≥dulo a implementar",
            font=("Segoe UI", 12),
            fg="#999999"
        ).pack(pady=10)
        self.tab_frames["Covers"] = covers_frame
        
        self._show_current_tab()
    
    def _switch_tab(self, tab_name):
        """Cambia entre tabs"""
        if self.current_tab != tab_name:
            self.current_tab = tab_name
            self._show_current_tab()
            self._update_tab_buttons()
    
    def _show_current_tab(self):
        """Muestra el frame del tab actual"""
        for tab_name, frame in self.tab_frames.items():
            if tab_name == self.current_tab:
                frame.pack(fill="both", expand=True)
            else:
                frame.pack_forget()
    
    def _update_tab_buttons(self):
        """Actualiza estilo de botones"""
        for tab_name, btn in self.tab_buttons.items():
            if tab_name == self.current_tab:
                self.ui_factory.set_widget_color(btn, fg_color="#4a90e2")
            else:
                self.ui_factory.set_widget_color(btn, fg_color="#4D6068")
    
    def _on_logout(self):
        """Handler de logout"""
        from tkinter import messagebox
        if messagebox.askyesno("Logout", "¬øCerrar sesi√≥n?", parent=self.window):
            self.window.destroy()
    
    def _on_close(self):
        """Handler de cierre"""
        from tkinter import messagebox
        if messagebox.askokcancel("Cerrar", "¬øCerrar ventana?", parent=self.window):
            self.window.destroy()
    
    def _create_event_form(self, parent):
        """Crea el formulario horizontal para agregar eventos"""
        # T√≠tulo del formulario
        title_label = self.ui_factory.label(
            parent,
            text="‚ûï Agregar Evento",
            font=("Segoe UI", 12, "bold"),
            fg="#00bfae"
        )
        title_label.pack(side="left", padx=10)
        
        # Sitio
        self.ui_factory.label(
            parent,
            text="Sitio:",
            font=("Segoe UI", 10),
            fg="#ffffff"
        ).pack(side="left", padx=(20, 5))
        
        self.site_combo = FilteredCombobox(
            parent,
            width=200,
            values=self._get_sites()
        )
        self.site_combo.pack(side="left", padx=5)
        
        # Actividad
        self.ui_factory.label(
            parent,
            text="Actividad:",
            font=("Segoe UI", 10),
            fg="#ffffff"
        ).pack(side="left", padx=(10, 5))
        
        self.activity_combo = FilteredCombobox(
            parent,
            width=180,
            values=self._get_activities()
        )
        self.activity_combo.pack(side="left", padx=5)
        
        # Cantidad
        self.ui_factory.label(
            parent,
            text="Cantidad:",
            font=("Segoe UI", 10),
            fg="#ffffff"
        ).pack(side="left", padx=(10, 5))
        
        self.quantity_entry = tk.Entry(parent, width=8, font=("Segoe UI", 10), bg="#333333", fg="#ffffff", insertbackground="#ffffff")
        self.quantity_entry.insert(0, "0")
        self.quantity_entry.pack(side="left", padx=5)
        
        # Camera
        self.ui_factory.label(
            parent,
            text="Camera:",
            font=("Segoe UI", 10),
            fg="#ffffff"
        ).pack(side="left", padx=(10, 5))
        
        self.camera_entry = tk.Entry(parent, width=10, font=("Segoe UI", 10), bg="#333333", fg="#ffffff", insertbackground="#ffffff")
        self.camera_entry.pack(side="left", padx=5)
        
        # Descripci√≥n
        self.ui_factory.label(
            parent,
            text="Descripci√≥n:",
            font=("Segoe UI", 10),
            fg="#ffffff"
        ).pack(side="left", padx=(10, 5))
        
        self.description_entry = tk.Entry(parent, width=30, font=("Segoe UI", 10), bg="#333333", fg="#ffffff", insertbackground="#ffffff")
        self.description_entry.pack(side="left", padx=5)
        
        # Bot√≥n Agregar
        self.ui_factory.button(
            parent,
            text="‚ûï Agregar",
            command=self._add_event,
            width=100,
            fg_color="#4CAF50",
            hover_color="#45a049"
        ).pack(side="left", padx=10)
    
    def _get_sites(self):
        """Obtiene lista de sitios a trav√©s del controller (MVC)"""
        sites = self.controller.get_sites()
        return [f"{row[1]} ({row[0]})" for row in sites]
    
    def _get_activities(self):
        """Obtiene lista de actividades a trav√©s del controller (MVC)"""
        activities = self.controller.get_activities()
        return [row[0] for row in activities]
    
    def _add_event(self):
        """Agrega un nuevo evento usando arquitectura MVC"""
        from tkinter import messagebox
        
        # Obtener valores del formulario
        site_text = self.site_combo.get()
        activity = self.activity_combo.get()
        quantity = self.quantity_entry.get()
        camera = self.camera_entry.get()
        description = self.description_entry.get()
        
        # Validar campos obligatorios
        if not site_text or not activity:
            messagebox.showwarning(
                "Campos requeridos",
                "Sitio y Actividad son obligatorios",
                parent=self.window
            )
            return
        
        # Extraer ID del sitio
        try:
            site_id = int(site_text.split("(")[-1].split(")")[0])
        except:
            messagebox.showerror("Error", "Formato de sitio inv√°lido", parent=self.window)
            return
        
        # Validar cantidad
        try:
            quantity_val = int(quantity) if quantity else 0
        except:
            messagebox.showerror("Error", "Cantidad debe ser un n√∫mero", parent=self.window)
            return
        
        # Llamar al controller para crear evento (MVC)
        success, message = self.controller.create_event(
            site_id,
            activity,
            quantity_val,
            camera,
            description
        )
        
        if success:
            # Limpiar campos
            self.site_combo.set("")
            self.activity_combo.set("")
            self.quantity_entry.delete(0, "end")
            self.quantity_entry.insert(0, "0")
            self.camera_entry.delete(0, "end")
            self.description_entry.delete(0, "end")
            
            # Refrescar DailyModule
            if hasattr(self, 'daily_module'):
                self.daily_module.load_data()
            
            print(f"[DEBUG] {message}")
        else:
            messagebox.showerror(
                "Error",
                f"No se pudo agregar el evento:\n{message}",
                parent=self.window
            )
